#!/bin/bash

check_errs()
{
  # Function. Parameter 1 is the return code
  # Para. 2 is text to display on failure.
  if [ "${1}" -ne "0" ]; then
    echo "ERROR # ${1} : ${2}"
    # as a bonus, make our script exit with the right error code.
    exit ${1}
  fi
}

enter_host(){
echo "Enter the fully qualified hostname of the system to provision."
read answer
host=$answer
}

select_env(){
environ_list
env=`echo $env_list`
   clear
   select func in $env; do
      case $func in
      *)
         env_targ="$func"
         break
         ;;
      esac
   done
}

select_role(){
role=`echo generic realtrans realdoc rabbitserver`
   clear
   select func in $role; do
      case $func in
      *)
         role_name="$func"
         break
         ;;
      esac
   done
}

attr_select(){

if [ "$role_name" == "realtrans" ]; then
  add_role="role[realtrans-cen] role[realtrans-ven]"
elif [ "$role_name" == "realdoc" ]; then
  add_role="role[realdoc]"
elif [ "$role_name" == "rabbitserver" ]; then
  add_role="role[rabbitserver]"
elif [ "$role_name" == "generic" ]; then
  add_role="role[all]"
else
  echo "There are no attributes for that server type. Check with the Chef Administrator."; exit 1
fi
}

provision_server(){
#host=$1
if [ "$host" == "" ]; then
  echo "You must include a hostname for this script. $0 hostname."; exit 1
fi
hostcheck=`nslookup $host | grep SERVFAIL`
if [ "$hostcheck" != "" ]; then
  echo "NSlookup of server failed, please check that the host is in DNS."; exit 1
fi
# Hostname was passed and nslookup succeeded, proceed with provisioning.
knife bootstrap $host --distro rhel6-gems && echo "Chef has been provisioned to the host." 
check_errs $? "There was a problem with the bootstrap."

# Add node to the new environment.
knife node set_environment $host $env_targ
check_errs $? "There was a problem with adding the node to the environment."

# Add role all automatically to the new node.
knife node run_list add $host role[all] && echo "Role all has been added to the node." 
check_errs $? "There was a problem with adding the all role."

# Add any other roles that were selected.
for i in `echo $add_role`; do
  knife node run_list add $host "$i" && echo "Role $i has been added to the node." 
  check_errs $? "There was a problem with adding $i role."
done

# SSH to the new node and run chef-client.
ssh root@$host "chef-client" && echo "Initial chef-client run has been completed." 
check_errs $? "There was a problem with the chef client run, check the logs."
}

chef_check(){
knife node show $host | grep Role ; pause
}

pause(){
echo "Hit any key to continue..."
read pause
}

data_check(){
enter_host
select_env
select_role
attr_select
#target_search
}

while :
        do
                clear
                echo "---------------------------------------------"
                echo " Main Menu "
                echo -e "---------------------------------------------\n"
                echo -e "[\033[36ma\033[0m] \033[32mCheck Server description\033[0m \n "
                echo -e "[\033[36mb\033[0m] \033[31mBootstrap a new server\033[0m \n"
                #echo -e "[\033[36mc\033[0m] \033[32mYUM Repository RPM check\033[0m \n "
                #echo -e "[\033[36md\033[0m] \033[32mPerform Chef Test Run on Instance\033[0m \n "
                #echo -e "[\033[36me\033[0m] \033[32mCheck RPM version installed on Instance\033[0m \n "
                #echo -e "[\033[36mf\033[0m] \033[31mStop Tomcat on Targets\033[0m \n"
                #echo -e "[\033[36mg\033[0m] \033[31mStart Tomcat on Targets\033[0m \n"
                #echo -e "[\033[36mh\033[0m] \033[31mExecute Chef Run on Instance\033[0m \n"
                echo -e "[\033[36mr\033[0m] \033[32mRead Me file with some instructions\033[0m \n"
                echo -e "[\033[36mx\033[0m] Exit\n "
                echo "==========================="
                echo -n "Enter your menu choice [a-x]: "
                read choice
                case "$choice" in
  a)
                enter_host; chef_check; pause
                ;;
  b)
                data_check; provision_server; pause
                ;;
#  c)
#                data_check; enter_version; rpm_repo; pause
#                ;;
#  d)
#                data_check; chef_testrun; pause
#                ;;
#  e)
#                data_check; rpm_version; pause
#                ;;
#  f)
#                data_check; stop_tomcat; pause
#                ;;
#  g)
#                data_check; start_tomcat; pause
#                ;;
#  h)
#                data_check; chef_execute; pause
#                ;;
#  r)
#                read_me; pause
#                ;;
  x)
                echo "Exiting..."; exit 0
                ;;
  *)
                echo "Oops! Please select a choice [a-x]";
                     echo "Press a key..."; read ;;
                esac
done

